///////////////////////////////////////////////////////////////////////////////
// Copyright Â© 2020 xx network SEZC                                          //
//                                                                           //
// Use of this source code is governed by a license that can be found in the //
// LICENSE file                                                              //
///////////////////////////////////////////////////////////////////////////////

package backup

import (
	"crypto/rand"
	"encoding/hex"
	"testing"

	"github.com/stretchr/testify/require"

	"gitlab.com/xx_network/crypto/csprng"
	"gitlab.com/xx_network/crypto/signature/rsa"
)

func TestTagVersion(t *testing.T) {
	blob := MarshalTagVersion()
	err := CheckMarshalledTagVersion(blob)
	require.NoError(t, err)
}

func TestMarshal(t *testing.T) {

	rsaPrivKey, err := rsa.GenerateKey(csprng.NewSystemRNG(), 4096)
	require.NoError(t, err)

	backup := &Backup{
		TransmissionIdentity: TransmissionIdentity{
			RSASigningPrivateKey: rsaPrivKey,
		},
	}

	key := make([]byte, 32)
	_, err = rand.Read(key)
	require.NoError(t, err)

	_, err = backup.Marshal(csprng.NewSystemRNG(), key)
	require.NoError(t, err)
}

func TestUnMarshal(t *testing.T) {

	rsaPrivKey, err := rsa.GenerateKey(csprng.NewSystemRNG(), 4096)
	require.NoError(t, err)

	backup := &Backup{
		TransmissionIdentity: TransmissionIdentity{
			RSASigningPrivateKey: rsaPrivKey,
		},
	}

	key := make([]byte, 32)
	_, err = rand.Read(key)
	require.NoError(t, err)

	ciphertext, err := backup.Marshal(csprng.NewSystemRNG(), key)
	require.NoError(t, err)

	newbackup := &Backup{}
	err = newbackup.Unmarshal(key, ciphertext)
	require.NoError(t, err)

	require.Equal(t, newbackup.TransmissionIdentity.RSASigningPrivateKey, backup.TransmissionIdentity.RSASigningPrivateKey)

	_, err = newbackup.Marshal(csprng.NewSystemRNG(), key)
	require.NoError(t, err)
}

func TestUnMarshalPrecanned(t *testing.T) {
	keyStr := "4fe3ce4682574ab1c23086898451d1e53175537406729238699fa5aad563795b"
	ciphertextStr := "3039006a699c5b2c96d7d30d7e8c22ecc7787d4379780d25cda1309ded87b247a624a9f43f37024a3bf45131de35df32340fe0e7cadd5225f8ec564880b2841c05582ff56ee7f9a9abd15a3be21b5f8ac8828374db5f056df48dd8bcc9ffcb5871ed6207932bed358b37d74d7f0e85ab6ad1ae02b0dc4b5f001a39f0be90b5272669092fc2efad4bd6897df0b2653b5c5324ef80fff18715b716a9dbd46859d55ae06cab1d0453299deb9b5b5a8174ac4c7ae1ab0d0d5733f052114085579fdaefa6697780792b4b7b009fdc3799adf178e8b2c3580587d6962e74e42cf82e89a88cf55db0f2973838694a42141ab6bfe9caaf49f91752da5158c4352fc3fe1aca6a4599ba76d3145306ad84cb399a695f2000c128b45da3cc5cda13da1cf62cfd09ac2912923a82637dd3f3613382a18d9c5f2d7bb053a6b4c39e5e39b5fbc91204e4ce82bfc95ba354f7185476736c75a163d57f39123673a87b7947e6b7c0c23c2bf0bef318e8888f21c6b5327e330a0640e30ecbfbcd280af2da287ca95ca08b550b8fc42d918453e081700513a185f1541e9f294e22ca1331d98bf62488b7ea67e6b3b624602a2954d22f687010aad5bad51a0d5c97bf9a96b25b7c883295c25c5b48e3c3ca445fdc63980bcedf19fc721550e19cd1b3f60ed0feede0765291dcda97820f1bd298361bfe4297d0621853a2725f17afabc49fe158d6e3bf762168edc59cf3613a8226f0f2bc8bdd589a5d586de02f54175d4c21743f3df3f3d091b07e2699111f9588b383a3366c28bf391a054e41177456627bbaf0374e2cb21ecf01b7bbf867b3cf1a90051872e6e553163fdc23aa6c8fdaec044a3941bb520151913d8ac3c26948818d129ffdd98c232519c0f5d8dfb5419766fd9867e19ded199e63d16165c5d01e4ea2af91656f60a242e0612706f083df078f35198f0d032fd5ded97de9b230e9e9c03fc2e11c53881093c8d215f2f3392594c6eb28016010fd787325d867099a3ab91f08d4270435ba579bdd36f0a6390a1297e50b2e164406d31d3a8b0eeacab4d9510afb2a0297bb7001fd6d259ead6d079fa4cd50b62dd777f828ec8e923fd683256ecf82898bdd84faf9edbd1949962b33a8a36b51553e28de9d7e073d61242c4e44284976f5ed657e627f8008ba95f20357d9de9ba15e0ea9284a21cdb0de31062b16a40e6ba2b731de377cd60a64253daaa74646374fd58aa30d1c96643e9cb7306a95be0cc356a3d70085bd1263168d82283a89eb18bd3e78adc29dae7c8669484c03c71e44a03dc71cd89ee5b2bf51928f6e3865c3207d4342e9658e0e8bb89dc0b902ca03ae94a5ac8b1146704d354bd18c22a2b87255f1c685fc7959e8343d64016190c60029cb1f379168f796ca58385d013a08a08f6779b54631787807da5d8a6168c5c04c93d864e0c64dd65fac1a47cdaa024c957ca64890e8ea9f18c4c6610fc48625584b6015a307b74ad28f6d427eb07238cc69702661ebfe298a2525f16bb2562ba914f8330d80a90b70a161a7e4c2d9448671949dd37ca0cac47f50a52082e7fa437fa4b2a04d6949c2d847faac83a7c4f96efb4a2df337e8953f2692e40c1ea28aebc7842e7d8b9efac148d5653c036f260aa24a246f7609949ae3612ae086e2f8925cd30d83454c173c60f612e265e03f4f4eb9084a774e7acb267b21bc1a731083d12dfe827584d7c1ff47de0efdcc1b8d224fb076136fa87fdc69663773719893f811a92c796b6baa974e95b4f11a755b74fa1eb29f9432309ec7666f3f8d3c9f6b52ca88c58ab7002b8c2969c56f086f177635a1649a9ce51069a649bc605ea34e32e1493eb60752f92d5776be5e384c264f0804f4d8bc9ba55ad13025b6007f701bd85418e78a8f0ef01849d99264fb120e0d34e725804066bc133aa2fe8e75af9fd55217c266aaae0c840389bb4ab3c09443ab8f6b56934846b91290c9f66d17a521949235ea213d2da46907f4096ea57df356822d7ef2e9f2617f4ec166b3fc68b291a03624d1f2123f2f3211a3bedce6eac2ecbab13d020373978230b6d53743add9cf5d7a0f135313b15cb913c6794583cff11d0a9b0c0d2cfbbb198067983e9b8bcef28b173e185aa7bfd07939f3253d488702a50f96cb94529425b5d021a7770c7a36ebcba841b9ee785af3ac36c00df8bee98824cccd770e62b4c7a87f226f03221dabad593c9c659a0220c4e372dbf543f0c5f5e1992f34699969e95f049dab556738392a9d797f071b5a137d8196f3e778e9a7d94b8e6ce9b983dd2114c3e0c918c13697f879d7804f1278abb72762c460125f24dda518e783e3a4234c11e0fc395bfa80418e2fbe6d2c54be79e59b0c9ea77864c42c6dd310a25380eadd0b35e9a80e8a9bece65c9e2c8fce24ba80a2eaa8f764feef49f7bdda4e07bc31bbe4acb0818e50718212102d64b08d095cdfff6ae8df18d670d949017e6a9108e975af666e77c4ac6c59fd5ede90eb30cad201928f5f52a1e26229563973ab49418b322514e942869b67ae7a68b22d2f052a332fae90c2a9b8138ee3e550b7bba9faed1a976921dc695e863c6022f579b482f455d20e3a19bf146751d5332f2368833bb9ad82f0ddae6b3bf2906ead50f8100324443ab77b29e645813685df531a5302828f093f92f83a9d2829587d3205b9cbc205ebaeb56ac3ee46cc1b2685d31db989b496ba55d4d95b75cda928b4770981557b103c4e4b856be8dd7890275c69635144da0d83330cc487f5664d93c1a16a18b85cebf023947387d8c00ba699a85079eaf10d31fc906358370d0b7f814e784b24efd5f449f4d28eeba5422b25d7ab4412d5fd8e6b7aad355eef8c2b7a4fb6b4c60d9266afc33932b28e0578e9c4a3ad72b21ba595c4fe186717fa78b754898d9963be58003d3655f6365ac241a006afd06521c609b2b62f36c87eb3e7199cdda915c50ceb640719104e8cf4d2e06a4bc999815e17bdf4d5d3eb88f9faef937f78c547d0e5f932259e0144b17cece6a5321a38e96157a7965dba4fa39d1d1127a4f0efa93db5cf9f251988e20329979d092501668b73db1168b8a132670bb9150c3b762fb94ccb96cdf33e2834cdb9d84098b2e16438c8e85d9533c9b2783e92902fc61be5390ed51f5bc371fd51e34f0f75f426943964cd0d5f985fb2c33766da9eae68d33ff7db5add01cdf44a2348165863a8e578b03ac80fa367a52594d0b2b4c9316d35a1f2c120886646f63b70dbb7e6f9cf1d0774fe001c305e04a32e27ed1c1f7f05eb0cf97861e4f785c28c177f647b1253bbb0448a6babff51e4a7ac941be95f334ffba2a02fa07bfadde9f5f75d15e51eba5eb15d6be18c24101f60c22e9d1d9bbd4e190fe6f8d170b53a9deb97b018894ca0451c820043318368ddffd5f7404d1f8dc7f2b29c4f4d711724464b26a38a11c464e72b458c03783ad42ade2c375fda9fa52722073cf6d0a5bc05ba50789632a9f44a7fc25fc3885bddca7085e516e4a7fcc90a12ca49d0ffb5aec456cf0f151572d4f0ae8fe901b0af5af768b493005466c5c50c19ed7263e0cd2c01d135164777a9f732a7b5da62944247a8a58be6c210e0e389fb28d86fe47f1aae0d8963f472aa220afe8761d0ed069569c2c3c5db9596c035834c7a26d8af11a1d3aef60aebb4443ea60b801d5ce241c7777617008b9305615d6b1ddc8c837b0b5468bd11c618003a45afb2f704baf9c06f5fe99f86f35f8b82bb884b7ad5ba7a07e086c50fba750938c04dd76ed59c7f98af3898507e7db9fedf0dc064998b90af399dd0d77f575641563a98ad0def48af87f7637e62d44c87f416f2e4cb6ffb3c464faa17b7cde16080991c5768600bc84dbfc7d02b4506fcd057ac4b4fef2a0b2fda80f65d30883d35945cfc7c845bf41310a69ad5048dc4dd4a94345d6364e3c214fe424a0d951e63a78cdaf237ad1e620d08d2f4fbb7ca3917062f07f171c186b9cb013c11413bd402a140d0a88faa82060f065269485719ddd8c994ada055a01435f61e37bc27621d19d61685f12bf44b83c106d01f38bb687fcc4afeb77fe910049251af009a93b8543331658f115323e68ccaeb2f64260c2a3535e2572f28bea44dcc6aba2d9b231a042f02b79783beb201d6d726033900a2ce4f2a587e4483b1426cd91042d57c5bb857b21c76a056a856439748f56930518613131eb42cc58cb9a71ddc412aed1b64d3ba0456b5779f70749117436ca0a738dc1eba5f3c01ccda6bd5d167da727b0bfba4a7a68c1e0e5794bed698f7a6eb68fec7ed482ece1e59c75d14f49d62736539b8f27bd05db1d94411ad8ba85d053c6f8c37656c53b6559739433095fd89f6676fd6519451a1a9a28373776c000e67ae85f9fff6a7b4834f9d4decfa176eca74d69b9065c47d1c742c2b6be849c41f63eaf22df0af76a0ad14f6241c06e2d575015f2b720652996aa8a019637935651fef0a9c7890587addba01b08f7db72294a1fc914230fd6f6e59f90e980a4277b13a8c3c48712d6400564e175196d7e0d68ed46cb4a4866e9799905230fc99b05959a83d6272d48c49d505cb216d535f9f1a6181b02b2c42cd68f8d12c717915d52e3eaee3c40b3065aa47fb004843913017b9572792be67dfb2e96f929cc0e5d0a5111f72f64001ae01c0e0582eff506b01b16f1aac9680f64ebc5c5f324395a43633f8fea72671887edbe481fe0193f1b4637e35bc551dba35140534f3aefa01ad6fad58860712f8ca883681fc5079284eaf7ec7eefc03c29d3d7901417dc4e6f9d6147ca8d140d27509590841101c0fa0224ff391cabaa70a14e05f984bbbb14895bed6e8915c9373353e10bf71c174f4b40607874d2ef0f9781821b8614e21ec4d7ff8882bc1daca7f02ab2c6b29f9025f2cab54d73c9166db30412c782b9ca9ee01a4ba733e1767be04cfe094c368213939fa2cf6a70e8c49c85d5857a215d2ad52fdf3b8e257f7367cdec7b45b888eccfad1d7e6ffe7fd07ce9cdc4761bc231626b55f83160206ebb853fde134429950b79d47b3a09c1ce1477b3cc01904708b2c26fd4109818387299ea118ef0cc94e1e21890a7af955777f0d735bf79e2203aa4785002d7197aa7be4085f804325d50d16354a0d04ec45614e7b7213484d0ad04cf455bf79bf9343a2d31e23e2eb290d69c81522fa8e151623e2a44d62486e9297c53b2ed57b6bbe76c4d5e2ca3c4cc6e7513dd2fa7a1de62f524409e63e59289a6c2cd9a7ff1da70e0d542f3c94021f88a90ea5771b45880a51fdc3fa58c62e0b72c573420a85a6342edfb25c84fa09f7a340abe70894f4f29e6cbbedc4b1e43d68037ce3feca9a630220a7584648e79dcdec34ec473bfe7fcf6910ba5557b20a94a309265f4cbecbbde1ea1717443b64626ed1ea9cfa3483b992731815a5016226cfa195c3f3ae15b05a0f2a1ab7a22ce16a5930c7c12c3e5a3382b654f79cd03999ee808fa21101ab0fe49f3e13b75938b20d2813ecb312339b1deb372b058d1b6ab860ed5131ab546bbc28fd60ff202af5b797747d11e46d5d64b47b6712dd43debe2648a6da961b1a1c2e12d57d6483e6fe06d0c4e538d9bd843d11a354d6e9fb13d2696b79106d0f40423f66e446e3eef101287f2d6fe55df16010de2532af295be89666a93ea531bf6bf5f9e5c49ecdb2833429154d6db29c3725423aaf3fdf69e62a31af5b5e2d73eafa8b74fb9b3cb2adec47998b7996b2173fb40f472ac49c2deadb5564f4ce2be7c91971d1d614b1d68a6abf16694bbd648439d099eec2178509fb65b82628cb07ab1c69ab9611a95618c0291e0459108eeb9b45bfc9f62d17854fb9b5bdfd0899496950d33daa5d63b44da22d43f49b6c64a0068818232eb3a45c37faa3d7cfa98c8ec84c874af212b28ff4fb9ef1e6d580dd4165ade443882474505b17bd692bc0d46c753d19b6df1665430fca3b809b84b5669ec1ad97ba893502956c3f85c3840cbc4891c7ba10ab42026ebf991a9233b8a42d154c894dab988a0b45206ca092dd2917973223f15963c9eacad63392ace4f9de602ff6baa7d61d6fb8aa3177b951520320cf4ba370c13373e4409a5d05a80324b9f92ea372cd751d555bbe8996341be6facda9fcd372844f621298d3c29b75bd9a72e6c73d7aba56d8c6b923d1ced1b6d067d59991558f49874d7329a814b6f0eb87004135173a0febe6f965a312e9ca6cd0995df834cdf01664073dbd2c2ef670a9ea0db64aa90ac29b843ff28574e16b9c380d10db5de9ca76f6c4f5da9f2cecf6a5ef2f803c7bcde12b933c7a371baffe32361bed5e063172c68fc2d1c342370b6b51d05d1b48343536aeebb86c11cdeef88f2b250747dcd33152f20b92f04f403f1d10d48e04df1feb351a273e2395b7d22807b17301879927c168cc58bf00c79fdbfe51dedd4a3a09fa0b08d9224d7cea7e608690081e509a105d0af6e385b1b71c34fba72ad0629b8b94ace4896214f92437bfe549770d8008d7097e768e77bf4dac87e5c4214b314e72378e2757c9b41f42bba27f919286dbe7a3c58b7460c221badcb4e9857b3d0e443dd55d6643aef6e841b76b21f6454168ddcfc32eb6f5120392e32d3fd05a256d9ed5a371e943bd1050295bc0cd1c84f7ac323c7a17e6475d1f1c9d7234e2144e4f91eaa1c29646281310fdf31a94e429382387ed867d95de8fdc73ff2470f054f8399c7181d10f79d659b4e2d2190379daa2e26af394433284ae24fbd59fa783069ceca00ae516aab4b8e308151a7d137eb7d2d71497756e114aa8136d9afa119a6365558f5a62367c04fcb0e75ba30e1ed6a529859d00b25b03ed1b67732f26f29f81b6cb72a0bbfe69c8bf253960829d010bfc05e17c4432ba8249c5a1458f1fe1de37bed5dcfbd4f241c033163a0605ae22801eeec9bcf1247cdf11b33f004b1ddf754c8693fe211944cac2a03182906c2d552c1e183a13b2fae9c5c76e54741c6b1e41ee7c61f2083e542f31543e4ace75526e91f597d676b8929a2a67127e501fbbb02ece384fa6268b0f48b294f9fd8be7e579817a91762d08802ef9b6838b505b699aac654f96722c3c424487ab2968ac29eb14ae5ecf5642cc4a1ec0be7ab62ad8c7cdb1916443bd9411ad7baf8a238d685455312c94ce14d2a3c070b33a8566a53d6805439ac8d0546c13fdcc305d21afe0e06c462e76e6e36f646629f0c30f76683263cea791718ca1b9605b15da0c347e67175620a9798052680e27989e844b4147a0c9d338e0412c321459ada940d2ae862b29432d0d5161a44499b721e728919071e1aaca2932cd795a93096cfe098b68da2906d62b0ad6f2b395edf83d0233b0c368bbb0be862f9505363f2517dad2939b0e317a118a1c5bd284368cd4bde5c645bf3138df2d3cb30aacf5427dd900ce43a105c28b1569e0a7cc8e8c784fbdd95ff858d8c3e55ed943ecf189504ef4cc7901b131a8a3d4cdc4bc4c3a0c274c874aea0b689242bad32678200818a4df9fc94cb092714f944208be1c25f29a11cc42da78e6ded916028f1fee0f5226b0f7409dc3c4516b261fa4969a471e018988c9b713e918a72c34c3e44428a1b23304dfd8bf456e3b9d7cdfd2b8110779cc60daa5409958df381dbaa934a6f57fda44ee56c2446f5fb055bbec2bf5dd89f3305ea2b83a81c7ee19ccd6daa58b88e9e1471720809dd7e5818ca4ee419a9240200ceaf438557307f2bbeab2e51b6d3c7a6777c17c4c010130a65d83a99306ccfc35645a0cd0e3437821fd8f58993903da82031895d03eb5ba604f7ed09cad4699b6d44c56ccfb7561d75f187f40fe86d9877a7e4db5bb2a8e94da63877c1ecc859b6391269c4cf68c0fbc99492a04257b8ade63944c727e30d6ca80b6005997965632a3973d3ef4db7efda5ac7349d1789e1054e7f1a9a990f8b50f5b4c13fd89ab77106fb97931042fb44c051538beafdfab803b100992b0ccbb15dc5c3a04fa5da7d291c4b3533a3f24a2e7325068c11fb53093541e8d0b3b8cbc35b9f690d85e57a31b280aeeb68898a8f43fa9f699ec35141f0ee1c7a3c21aba14b1c78e48b763ef3cf75b53304b3e2cafe9d71f0f23b043688e7462b0633548a7db2045886d5ff97b99e0da4a426d387c415264fbcc0360f9e2079236b6ceb3fd693e69a7c7eef591e3e276d60ba1267b2e09ed93a1f8174f21ff8758290cb3a14bc7c49b12369197307fd97896e745536e74a7be5a60fe19ef608b9fd296e3e8caa654dc2b0a1401511fbd7601e900db2cc927f6af2bb82be06fe9dcb13a909897063da16402f0635f6d25291bfa09af2974eac6736796ad39650102d0161dbe444f9395025489ad2093fa397ae8f3026784da6acfde788dd33e5e426c80347dc972615d892df9bb3be7492d3b0ddb1c0129bd986ecda6d04343ecd18eb58557a621a796953d77e8ebb3e4ccc353ab76b63f4d67e1b0cb7b0a4d9c93a4833bd1b0a99f3f8895e4dda0666e4eae24522109ef0811cfee1bece035"

	key, err := hex.DecodeString(keyStr)
	require.NoError(t, err)
	ciphertext, err := hex.DecodeString(ciphertextStr)
	require.NoError(t, err)

	backup := &Backup{}
	err = backup.Unmarshal(key, ciphertext)
	require.NoError(t, err)
}
