///////////////////////////////////////////////////////////////////////////////
// Copyright Â© 2020 xx network SEZC                                          //
//                                                                           //
// Use of this source code is governed by a license that can be found in the //
// LICENSE file                                                              //
///////////////////////////////////////////////////////////////////////////////

package backup

import (
	"crypto/rand"
	"encoding/hex"
	"testing"

	"github.com/stretchr/testify/require"

	"gitlab.com/xx_network/crypto/csprng"
	"gitlab.com/xx_network/crypto/signature/rsa"
)

func TestTagVersion(t *testing.T) {
	blob := marshalTagVersion()
	err := checkMarshalledTagVersion(blob)
	require.NoError(t, err)
}

func TestMarshal(t *testing.T) {

	rsaPrivKey, err := rsa.GenerateKey(csprng.NewSystemRNG(), 4096)
	require.NoError(t, err)

	backup := &Backup{
		TransmissionIdentity: TransmissionIdentity{
			RSASigningPrivateKey: rsaPrivKey,
		},
	}

	key := make([]byte, 32)
	_, err = rand.Read(key)
	require.NoError(t, err)

	_, err = backup.Marshal(csprng.NewSystemRNG(), key)
	require.NoError(t, err)
}

func TestUnMarshal(t *testing.T) {

	rsaPrivKey, err := rsa.GenerateKey(csprng.NewSystemRNG(), 4096)
	require.NoError(t, err)

	backup := &Backup{
		TransmissionIdentity: TransmissionIdentity{
			RSASigningPrivateKey: rsaPrivKey,
		},
	}

	key := make([]byte, 32)
	_, err = rand.Read(key)
	require.NoError(t, err)

	ciphertext, err := backup.Marshal(csprng.NewSystemRNG(), key)
	require.NoError(t, err)

	newbackup := &Backup{}
	err = newbackup.Unmarshal(key, ciphertext)
	require.NoError(t, err)

	require.Equal(t, newbackup.TransmissionIdentity.RSASigningPrivateKey, backup.TransmissionIdentity.RSASigningPrivateKey)
}

func TestUnMarshalPrecanned(t *testing.T) {

	keyStr := "8ea507bbbb9d7be6802517b8758d5b8dda3b82d097bc82533c82c39df9dae04a"
	ciphertextStr := "585841434354424b00aeb5fd4e7b53e10647c32b72e5c5b857722b30f73af0a867ef55a8453ea902e7a177e72a475855f43ffd7884bf0d14413d122fb02f14dddebdb5aa6b2f164aafe15b12ff8c864aa6f8e95facb068e6a677049d719341e2bbb501cbfec091ed8ab3cd735742abc44aced4dc5d1023e307e381b70461185ca33b91ac5ad6c144e95c76bd4b54624e25c6831a1318773abce659ccf7c3b48d71a62b0c2d62c4637bfbccd4ccc43c1fb53666c29779c43c24ef10099c35f61e08e8532a09c86420e5790eebe96054013c224952db9c90ed76ee3f4a66981a142b2fc5fd75b0728f3c2027bd400999022f7af0e16173a019d424360d37cf0b254d668739a50a42b124ec75868c2270a7229729ca0253a5076b53e9eaf6f1c09a44a2a9f0cf681579194217a21b912d6f7793032be2fec618bdba827df7d6347572660d111eddd0b933bc979e6806f5e659d05fd22d4902c141b9b87024893fd679be5f386339120659a8b18dcc8debecebc824711727b0b039ae64289e5581585c931a93a1c4261a4f4c9c48622f09e472297ca3995b7357f5b4c1a5b711adb1012e88ec8c8337b5231ee73c1c48ad8331b0562a65ec3d42c4678184807ab281ecc0b8ee848f61c9c934b87faf271af9c57b46447aac23559fa6019c1f018f67504da94e54c6087989ea7f58d6b13bbb2bea689e9015186718939d4407f832ba0d51eaf50d803edc1c4d3126920fc6abd18f0a201d85ff2dfd1949b87c81a0c96cd6fdd8c61b1059863ff6ebc0a684a9c587dedd422156894d1c13389259d8f10c12340b5236db3127795e79cf5e2c3dcb9ee974883a13f2393d21f0c23387fc5b8cabe7af41560ddc880302002c5e38bb23d1e66fea72e460791a133067aac52864d491a209a49063602fa45e96d8100269666c02fcbfa3305c34ae46e6b89421b97da2ab5f0a3d67c61161e0bea6dbbab875fc9d9e9250585e72e67165189123e9c2964305e1b542d3330f2116179ac2253fd681bdb181e4cb565a228c9e0cc52e08fa37b3d6747b50f166e023dceec2073f54dca4bceffab5dea510aeac61e529e25bb30437b1ce61570aff29e29532563561432db73f70852453803fd180e699b4886c6cabcf7f5423933945f8547eabeb0387c485b677b606337fee8180329bf1394a0bf5645da8c5c1415937c9fca0215f864382e32418761c3679144fb820f32a6f31df34e78a8b743b884de334fcc5775b675cfe919d9021f4fc574f763535bc35b335338349a304ec6710605c486efc945a8c0475f9ea11c3a02fcadd36fa2d810cd9028bcc972cf0c8f5e7ad3e146d55c1e63bfa4f9acb11e8f3cfed39cc0689ede5f37ab501485f24117f092af94031cbb979142b9eeaade70eb6b309573dc9965d5fcc9169e4c0d51d4b1e62afb4fc5ae7315af5e51c52590bbcb51aed04b1e3b5eb77fe37c04f328d1650ee93ca208e436432eb76a16ccef11cd48531d14f946298d215bce50e4a715fda08a7c3a7529248f2f29e55a11d79ba197f8392622de4a5005ec051f797cfbf40ae462c5a298961fcd6c3053f85ddef8d629088f13bf508764b0ca8b59c59587c5cf1471fe2b3275beae77bcaa65646872a4b9b9fdee95b5c4442518f199ec9cdc37cdf58c2d403436b9901277c68e3f5ea172f123eace57810135b8842e9c7fafc0104252938931dff6c368a76d6717e2ce0f90e08d69c215051d82f53093090f1da8564416e63450b2f35b5defe53d574a612bce8a2ec91604e75d19b17d4f9ddecf93464e6d9aec6d2af74df1974638458a697c363305353f0780da85909322711e8ae51ac27d5dd04a7a508ed6ca547cf052056e935dd0f4382edd9f7348c774292f91c7822036928ed1bd857c058c105929b4cc8091155b6d59bab8a8363edd45fe7d6d19405dcd24a7360babe9bfd42387ce4fb20db3abbbde50d00dbb9a946d9cf3495c6e107d6db63016357c5411d35f4433551b0a9cecb4f99cd732aacff0faedb7f05a102c097cf2c783761b9b8a3ca2d1378ded92ce1c46eb3051414274349efc93841dad78808333f0415f674a4978e6000b99fc0dad3e1860bc96f1ef328aadb890d629630a91080854c660f2f50b85b5c7a9e42b6ff8ed047e6d62aca50b152df37e95841cc1c61035a42308256aed16e90ef2443923af6bc79ff99e40c2e221a8f8a388191655e27087cd9ccfd5dd9ae6fdcf54acdb877213bc791c4d7b6c5c96e24764934b07cbbe9ede3deeb54ad677296cb9c2289460a6915db3b3cd572623f67098cc95cd23b396cf5c0607888a3c48c30689effb1a7be4122eac2203b08921981e737253a4be48f7aa51205147c4d82537fa700de2e02f4c02703e6955f10c82f80782f9de76b0ceb29fc2acd4c4e2d119b191f856a6ce24101c3ed3f95c422b386ac595f9b243b390dc27c4e82b110b6fe81c42c6b97d38fc81bdf096950830ce79101142df8beab5d69c59fc4b6a4a626ebb4adb7e0b72014898605f9719b6646b890f513a8798026aedb10e3bdad4e9e89f0c108b0f2b1417fb13c6566f6d8a55b1bca3037f2b8a75aa3c4bd9e37d5cfe4dc513cc5882757e4b11464ff21fad8cbe22d83a665cd480ee5e6901e6869bee38600b7e4053e1f3dd67b7cd7f215b77aea8f96b8e57a5bb082a12314db28f47362d77f9a954d3c4923edf7c8e95d630273f75d6ef0fc6c8acf9ac3052d2d945d58f8cbe9b86750ec5fb91143aed45b6e51953f0abf9a9f742283bf2d4e534394e65990d8e78d52fec118b03410cba335bfb7ad5c33ab609f349215a161e21def00f58e02a9cd0b17ca365fc5d9564960c80c6c8e8262262efcd20177765cdc804e21b51ecf884ea4f6dd50272c2f2fe5c5dd95e88261b535885eb9c6d977a3f16bde2a363351fe7cd346c7e866426c7627f8d7ce7b0503c08965d75a7c7d16525e54e1a50ed2f0a4af54c0fafe03fe8dec728c6cf4d412c66ff5c595cc2397b02f6bbb0a02adcc2b60b48cd4e3d4a1d5f4dd2ccbe0a945e1caed3cb54442a6b4066b49ab28cad8aa0e699d37af0ac9aafaadddaa43baf0a6bbd49e9215834f9bbe3ad7cbf7ef9a78987f6e036bd0bf9658f93c328b19ab152ef918ca20c861ccb5bd1867e69fdc43181c18304289cafeb9a518f7d55e60f4c3e07816e7b4bfce3eee0c1f61b1a5d14889ce6da4003c4ca7a8ce7de80eddf950f1618d07bd0af728a09c55805345fcffb60d911800b1e06fee5aa77d967d74fcedab961d91ce1ca9785512f01849dc3e4dc885f33ec4cb4f25fffe6964c6c8252605b4e0927fa32ea767e181ebc8905b9390ef27d1f31cda619f1c24a79da1eff8ff503ba001a0dc615820a2d46ddf4a263e1736d5540891cc81b6e2d6d795eddefc42a4c7df65029b05e02af43e3a31822d9988335935800b8c5feeb6cd293fd171c2d19c374f4faff2bf13962e89a86eed7a8600edd0ebd78fc6e730c7140bc60f811b082f937e9f6033bf6af1a441883e50fed1cfc43fcdc44ad96e26dfb544366f96f0af6d31a529b8601b19430e0663617ca9d0fe7b4b33eaee71c1077bc7f695941d54237ce4da0e8eade300d4e975acbf45928479865765d764248775dbc751468fbde4f1791f43bfc64bbdc260fafdd97a86b2a623c11e9b505c64bec90e68c5ee2058a40dc0299c3a7c53386e959e7f97fdb1f865d468a06c17765273d8c0018061488e23dcde1326fd12fbe265341de622a6abb4ef146740f469d83bdb14d91598888df7c9a3c406afd20ece2b009efd991c8b2ce2aff626af0f0380c67605ce44d0f63ee14a2be955c86c1cd30116dc0d97e11b62eff7c3c49cde97b794edb4a68b495cdc2f49780c270372359cc5923076b9966d64542b544d0a5c9201f545f34cca031568bac202dafc93d46c4b98e41fb252614bfee807dae20f9ba7d530a07fe6c0e80c039ad34d49118524f8c9149898aa153ebb065db5482d29ee23b917e35a89de7e9992e80dca9d7d851f733a9d2426ed5f4de4d57c0a5de2ef0a42ae63ddd372424043327abc4c004f33f3fe1411fcc3b1efc9914e9763a27d058f52e93059d2b0fb0c4920a823d7fbc18a78ef46dd17e1df15925524177fe54ca55781216178517d881afe0857d3151f8d9c07ed13bf977d5fa4b410ea8f393897ce24ef7bd34db8d8cdd86da9be9ef3d338968dcf27a14504da32e3ddc079c611c0c9fa1504ae2114ded476118695fbbd7a43b659687b6660d2c470ca1dcfeabffab527d54154ec99384cf60a1ab56f9a463e3259875578ac1cd482dc3b12619157b9104961ecd1b7c95790a79dc8a83d47bb4bae43d33b6cb5b7cca802cf94638288ae544faaaceb5fc081e6d6fa17a9ca9f22b6c68ae815cc21a692bde4a7313bff840158cf90804fa2580df71ff6fa185de0d8ffa96e66a82b843bbaf232abe0ed975a27f916c29856690e9746e87453d860b94e74f6df7bb94f5f9a83d80725f465297739dacef1f2498ea8a7c4cfd2714671d8bad9713df2e5c85e7ae9227894c7899128255a78ea28d5a98bcc2733cc7849de7e5595f2f323badadcb64778060f0dae95710555e36a360ee7c4fcae175d63dbd8b5fa704de165bf7b6844b78787e4434a96751793fa4ceadc63a306cd7a5a323597181131e585d4273a6ccab504e892c53bfd90bf60a8597c2ad859d6c7e749c49cd3641e6e000f5d6f296c826d2d8a660c51fdd0409052868a8000db0bb9703d1551882386d66802fbba93750cd58ba18635e49effcafa4eb52e9bbba20681bbc73265b865aa139b5cdc8b3b377006b83157b9174fe25d56db4cc7da939910e6f3b2e54dc2629fc6b74fbd9bfd5f5cdec897a1bb148cb59c58d8521670e853114ea8aca564e3427e9d4aa4077c7ccf8763c0eecfbfed74db7110cad6545bb9444ea35bca950c13d20cccb1b3f1c0a06588b05731ea36f4417a6ca74dbfffeb221f1f971f44a47de6fdce2c22f51ae170e984b0541d45025bfd83943feb11445fb4aaa32004abd5aad1ca15e6e4f87d5e0a11f870fb9671daf8b29e89ac7f635821d1e1a4d58957773c6351d6142bcc06786c8719e5a7cbecd4743c4e61c27c3ef4e374ce5919ba81a8b2c40617f389629caea8b0493860194c2377be41a2c85b1e658b4727addee4e23426392f89fcb3ee370fc3f295fdaa38f22503536c9504200364e5dad169e17af0ab243d5c0e9a62beadb0df53a1a54890f07facea79621cd322599b3ca0c3ceee08df29c5dcdf2a991a880c0027f3a5d191d48be1d3e7a61caba880ae367432756322039c4359ebd5b10290298791c085fa9a10c29e8067fe7b3f449ce9b50d7290e85138dc93e147d6e49f0dc192d1e9eac95b2fb08deaab0071975079ae20f1cd08ed9645a2c4947a98dea6016bc578e007a3950fc2d91ad6e2f884de6da3c42a51d8031dae8f9a02e316e38c87607655890377ee15f1d90a5d61b1001fc049bcd2dcffa0c3c9d6b1af09a24efc6f757b0cc1a934445649dcb2620f11bd0cb549467448d458d321351523b77c1bf1bd6e1c5ec5143a59e054134c0c9389fbd6fbf01526b51fbf35293aede17f2d83834079f0293f321196f048ca5e34308cb9d569ce1d42ee674884929ebd715a3471ec21dfeb0c2bd9d3cad9802c9245bb6975b468839a73643f5b26878ca07ee4483a637986b7584e760a0e5ef3c27f54b8754eb88b6529d023e8c88988a234949c6c268bcec9a961b5e6c1caa1e1f3e5be3fe7f929ceacc88c11faf054f9eea018b5c75ea2b018440b7e42008b0003dd0c09cf1aa5d8e209ecf54bbe4f2a3d5d6378adc5b72db11b756b33fea53743cb22e1975028a4f719f2486030c2362276ce358f2365d398b29b8a61c5c34f2c6e3b71433da5bc50612d9affc15bc9cfa5703559b091edd851d72540890f54484a98525866edb94bdbbce83daa81bf3d8b16452a61dca7bffd9ad6f471ccd62a95701eacf6329f84d6fa0ce258da2476cd9e1c180b7735714e06d0eab3dbf9298c820ea082b6cc851428b303136837d9e18e48390e412fdd32fa6a84cd0aff75da53c4d318488c618f5e88896a02ff64cc2893ec812e04f6fd9a334bd9d790130096329233eda6f74444c97292a0669f4bbbfa03ec447c15e8da773efa75be3860b2d646d34b7da32cf9e45c2ca9e197958bf44c2020703e977edb96c2879462005980cbaef32ee3c9d426e0cc9c59ce1339586018b11d0af2fda3baa0b2cd91aa2acf53bcd5031ca3a8154106df3ea69f8efd589af0d8abebe2da7764a4068a834782709928f7e44d928dafd1ea9d94047b73d5fc9c5add1882beb12025059b842abc10a580b20a518dc30619f7b38fd7943d30392e186d944866ea6877c63fd093bab3ede9407630210ac62e64776313eed60633e3ba0df47fe21ea48e5cd3b7a16f5983177a96929eb2f8891cc6d17103538b682d20b77e7b0dd887d5e268ac5af5fd0d23b71630befd455821dad58622b6277709c226a85079b1556029c6ce0bf3c4e437c246a568dd02f38d40d82850b4ed67deda56d1640a6859fd40eef96e275c6c2dea818ebf2e7d09943001b301b0aa3237b2d978de4d3182da8c1f2865c9715fe72da979c48e167ac326b24b4d0d2bd895a3e6aa9c5b1ca78a2cde2be3ccf39241405f96f94c6cee083671200822d4fbd9cca4dfaa457e376ddc1691018bba58a82a441a57b5e2f513c431448218d111186a85ca9a6c75ca6899facb709300b93088876e42c5323646ddef0da689d48489eecaff85c3244a261179d678bd27de291b3ac8cad6dc55b5aa864e6dd5e61e96d14133dd3707398dff60eaf6775861da568e0ac731055765756419a7ca285af21ecc1703ce93ec7687aca43f45c260056709a3369c94a7e1f5006ee84b5e4188e1ed476e94b32916c394e42ab02d665f6135452cf1e2f929f74efa6b12d2cd56f4b0c390570aa18a595fa49ccebef8d0df6032ca65a04133e8c5a5c3e93ac8dab029212bde7c9a650b6dbedc98a8ae26156843187044cd1ded48deeac27b31b21a8241fb1380a14e04b48a1dddca68265b04a26d0cc4453ed961f1b7a5888b1118d88cfdf568ef8de8a4fb842fe5a09638470f60ac405faf1cc382a186e71cdb08001fc4588392b12f801b8a5c08a7415e7e9e62aba9428810f28499c82d43b8714749b92165fd2d723816b79d24e49daa63618af7da58bd16f1e0baabeb0c56bfa64228ede4168b234ef20d6a770f7bbe1d160976752d1b1f61403bc371ad9f852e02b9b58cd8a93a8d4c562ca7981c49b930fae8e68075fddbe69ae379a573792d2e243f88ff1b350ca350dca89028abd8927f14a84ee4101b19e44e2e301567df34a2acbaab01a9e5bcaf3b7d051b4bc27d4fcbf0a6683610f6c3af4dfd31677d99292cd0801460b6659daa647a7cb44da930a7b922c34c750fa9763cc4cdcef4dc183f91454bdf7c718eecace1aebc78e38553a975d89e919a2b69b2d327901371433cbf086547d234e307d08be8258cde729562076833fc36db4340cb621fe6ea9c136ff47cae7de66c025bef6459d0e77e1ac0b4d3f0536eeb44cdb205e43cc954594f83da2e06fc9017772e8c3ff118bb0a854da41c47d985005d90c07b59026479d72aa44dc1001b9b5ce64f1007087fb22390636d7d29fadff5823601c61b6e19c078d6829d6e017b59741e19799e0db780b3bbd8998673bbc717d780e6f533a6d8ccc2b95f394b9a6f8ae773b4ba6d0fe57c05ac0cb8403e69550a5cc01711321566de6e08be5b234ec6988556d312fadc2755d1fe74f8203d33119b43f47c7a140ec9a86f6cf5b1f6c48decd4c9301350b693de0b9e8bafbd6d4442bd2b6de1a7ab929d267e0e804cdda1b693edea6ab28a154bb1b3fe142b17aef4f353b78d49629b369aca4e2729588bf82f9161f6da622f9afb2ac196d868ae9549b8eef8c1c72eea8fbd195f2dcc5a2d00fddc2b6f5594db01816225f85c5d16fe7d1d72084aef5a925caa30f6da3c2d0169b14d2421abe7fe7d3f74da6e31281cd946d2083f6fc12c699433117720467b4a03c49119fcb36983d0e673472138d2c69fb22febd3ff3d2bbfcc52cee00928159a597268a85ffc07be27400c08987cd970d43e1c58bbda8b137638ff1ea05e419c24e3597763bb06dd30226a3fd5697c882a98027c95d81cf0290ddea3baf20e13fdb5d6cdbb89e8fd97d9c773ad597bcc4af994525e113f1601e79208d7f8e392755716d7d3722a4b69a8640d8941a0e4f135f2acd13c85e4030750b951aefaf2ddf62522f8c9bf296896fbb609f235b563d6da6a045d8fce932177352029bd26d1cb8fa0a4b7b06fa9a9cb466691776648cbd205e655359359ddfd7e6ea51de6d5e28b971fa385f6139e1fd0035cc1c20ec6a6cf177922776d77f7edd8c68e62563056e8c990911d2f56531a195aef68dce388dc17806fea2a3f6570e119b336e0af8d1a71e61caee8d8fafa0c9e4bab5cafad295212dd59d8852805c7c1c7145ea7fa"

	key, err := hex.DecodeString(keyStr)
	require.NoError(t, err)
	ciphertext, err := hex.DecodeString(ciphertextStr)
	require.NoError(t, err)

	backup := &Backup{}
	err = backup.Unmarshal(key, ciphertext)
	require.NoError(t, err)
}
